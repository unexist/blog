---
layout: post
title: Building images with Dagger
description: TBD
#date: %%%DATE%%%
#last_updated: %%%DATE%%%
author: Christoph Kappel
tags: golang gitlab dagger showcase
categories: cicd
toc: true
---
ifdef::asciidoctorconfigdir[]
:imagesdir: {asciidoctorconfigdir}/../assets/images/building_images_with_dagger
endif::[]
ifndef::asciidoctorconfigdir[]
:imagesdir: /assets/images/building_images_with_dagger
endif::[]
:figure-caption!:
:table-caption!:

== What is Dagger?

=== Examples

[source,go]
----
func main() {
	ctx := context.Background()

	client, err := dagger.Connect(&ctx, dagger.WithLogOutput(os.Stdout)) // <1>
	if nil != err {
		panic(err)
	}

	defer client.Close()

	build(&ctx, client)
}

func build(ctx *context.Context, client *dagger.Client) error {
	fmt.Println("Building with Dagger")

	src := client.Host().Directory(".", dagger.HostDirectoryOpts{ // <2>
		Exclude: []string{"ci/"},
	})

	const path = "build/"

	golang := client. // <3>
		Pipeline("Build application").
		Container().
		From("golang:latest").
		WithDirectory("/src", src).
		WithWorkdir("/src").
		WithExec([]string{"go", "build", "-o", path})

	output := golang.Directory(path)

	_, err := output.Export(*ctx, path) // <4>
	if nil != err {
		return err
	}

	return nil
}
----

== Gitlab and runner

=== Setup

This example uses [Podman][] and provides a Makefile to set up everything via CLI.

[source,shell]
----
$ hg clone https://hg.unexist.dev/showcase-dagger-golang
$ cd showcase-dagger-golang
----

Following commands are required to start the required containers:

[source,shell]
----
$ cd podman
$ make pd-pod-create
991e7a69b59e76e051d87ef756169c9ed53e4b4090650a0e41cd09cf6ffd7eb9
$ make pd-runner
ccae50ee774957a4c0daf47b5ed15f40353ead1304e232b16924bc4026db2029
$ make pd-gitlab
17349b87f81aa9eb7230f414923cf491c84a36a87d61057f8dc2f8f82c7ea60a
----

Once everything is ready `podman ps` should show following:

[source,shell]
----
$ podman ps -a --format 'table {{.ID}} {{.Image}} {{.Status}} {{.Names}}'
CONTAINER ID  IMAGE                                  STATUS                       NAMES
09ef2665fb09  localhost/podman-pause:4.3.1-0         Up 2 hours ago               991e7a69b59e-infra
ccae50ee7749  docker.io/gitlab/gitlab-runner:latest  Up 2 hours ago               runner
e88fcb56c786  docker.io/gitlab/gitlab-ce:latest      Up 17 minutes ago (healthy)  gitlab
----

The webinterface can be reached at following address:
<https://localhost:10443>

=== Register the runner

Due to the new registration process of Gitlab v16.x tokens are obsolete and the registration must be
started inside Gitlab via `New instance runner` here:
<https://localhost:10443/admin/runners>

== Conclusion

All examples can be found here:

<https://github.com/unexist/showcase-dagger-golang>