---
layout: post
title: Gitlab with Podman
description: This blog post is a spin-off of the original post about the programmable CICD system Dagger and explains how to set up Gitlab with Podman.
#date: %%%DATE%%%
#last_updated: %%%DATE%%%
author: Christoph Kappel
tags: gitlab podman showcase
categories: cicd
toc: true
---
ifdef::asciidoctorconfigdir[]
:imagesdir: {asciidoctorconfigdir}/../assets/images/gitlab_with_podman
endif::[]
ifndef::asciidoctorconfigdir[]
:imagesdir: /assets/images/gitlab_with_podman
endif::[]
:figure-caption!:
:table-caption!:

////
https://docs.gitlab.com/omnibus/settings/memory_constrained_envs.html
https://gist.github.com/Mearman/318b96efb31ed33d9c2efa959784d6d8
https://en.wikipedia.org/wiki/Convention_over_configuration
https://registry.gitlab.com/qontainers/pipglr:
////

== Gitlab with Podman

The ultimate goal for my previous post about [Dagger][] was to demonstrate the combination of it
with [Gitlab][] and [Podman][], but unfortunately I ran into so many different problems I made the
decision to break it apart.

This is second part of a small series and explains how to set up Gitlab with Podman-in-Podman
and various pitfalls along the way.

NOTE: If you are looking for the first part just follow this link over here:

{{ site.url }}{% post_url 2024-05-15-building-with-dagger %}[Building with Dagger].

=== Preparations

The first step in order to start Gitlab is to provide an SSL cert, but to make this a lot more
interesting we rely on a self-signed one:

[source,shell]
----
$ openssl req -newkey rsa:4096 -x509 -sha512 -days 365 -nodes \
    -out gitlab.crt -keyout gitlab.key \
    -addext "subjectAltName=DNS:gitlab" \ # <.>
    -subj "/C=DE/ST=DE/L=DE/O=unexist.dev/OU=showcase/CN=gitlab" # <.>
----
<.> This line is essential, otherwise Gitlab won't accept this cert
<.> We are going to use *gitlab* for the hostname, so make sure to add it to your hosts file

Next up is the actual config of Gitlab.

There is aplenty that can actually be configured beforehand, especially in
[memory constrained environments][] it is beneficial to disable services like [Prometheus][], but
here we trust in [convention over configuration][] and just include only the bare minimum to
run Gitlab:

[source,ruby]
----
external_url 'https://gitlab:10443/'
registry_external_url 'https://gitlab:4567' # <1>

registry_nginx['enable'] = true
registry_nginx['listen_port'] = 4567 # <2>

nginx['ssl_certificate'] = "/etc/gitlab/ssl/gitlab.crt"
nginx['ssl_certificate_key'] = "/etc/gitlab/ssl/gitlab.key"
nginx['listen_port'] = 10443 # <3>
----
<1> Setting the ports here cases problems elsewhere, so better also set the ports in <2> and <3>
<2> My initial idea was to use the registry as a cache, but more to that later
<3> Nginx usually picks the port from _external_url_, which is not what we want to do

Like [Kubernetes][] Podman allows to group or rather encapsulate container in [pods][] and also to
convert them afterward, so let us quickly create one:

[source,shell]
----
$ podman pod create -n showcase --network bridge  \
        -p 10022:22 `# Gitlab ssh` \
        -p 10443:10443 `# Gitlab web` \
        -p 4567:4567 `# Gitlab registry`
e91d11fdeb168c5713c9f48a50ab736db59d88ae7e39b807371923dcf4f26199
----

TIP: This can be done with the make target `pd-pod-create`.

==== Starting Gitlab

Once everything is in place we can fire up Gitlab.

[source,shell]
----
$ podman run -dit --name gitlab --pod=gitlab \
    --memory=4096m --cpus=4 \
    -v ./gitlab.crt:/etc/gitlab/ssl/gitlab.crt \ # <.>
    -v ./gitlab.key:/etc/gitlab/ssl/gitlab.key \
    -v ./gitlab.rb:/etc/gitlab/gitlab.rb \ # <.>
    -v ./gitlab-data:/var/opt/gitlab \
    -e GITLAB_ROOT_PASSWORD=YourPassword \ #<.>
    docker.io/gitlab/gitlab-ce:latest
17349b87f81aa9eb7230f414923cf491c84a36a87d61057f8dc2f8f82c7ea60a
----
<.> We pass our new certs via volume mounts to Gitlab
<.> Our previously modified minimal config
<.> Let's be creative

TIP: This can also be done with the make target `pd-gitlab`.

Once the container is running Gitlab can be reached at following address:
<https://localhost:10443>

.Screenshot of the login screen of Gitlab
image::gitlab_login.png[]

Great success, but unfortunately Gitlab alone is only half the deal.

==== Adding a runner

Setting up a runner which is able to spawn new containers inside Podman is a bit tricky and
requires to build a specially configured container first.

Lucky for us other [people struggled][] also with this kind of problem and did the heavy lifting
for us:

[source,shell]
----
$ podman build -t $(RUNNER_IMAGE_NAME) -f runner/Containerfile \ # <.>
    --build-arg=GITLAB_URL=$(GITLAB_URL) \ # <.>
    --build-arg=REGISTRY_URL=$(REGISTRY_URL) \
    --build-arg=PODNAME=$(PODNAME)
----
<.> This relies on the [pipglr][] project
<.> This is an excerpt from the provided Makefile, so please consider the env variables properly set

TIP: This can also be done with the make target `pd-runner-podman-build`.


=== Registration of the runner

The current registration process requires us to register a new runner inside Gitlab first and
this can be done via menu:Admin[CICD > Runners > New instance runner] at:
<https://localhost:10443/admin/runners>

Once submitted the redirection is going to fail, since our host machine doesn't know the hostname
`gitlab`:

.Screenshot of the wrong address
image::gitlab_register_localhost.png[]

This can be bypassed by just replacing `gitlab` with `localhost` or with a quick edit of the
hosts file:

[source,shell]
----
$ grep 127 /etc/hosts
127.0.0.1     localhost
127.0.0.1     meanas
127.0.0.1     gitlab
----

Registration of the actual runner is a more involved, but remember the stuff other people do for us?
pipglr, like a good guy, comes prepared and brings some [container labels][] to execute the actual
commands.
I took the liberty to throw everything into a Makefile target, and we just call it directly this
time:

[source,shell]
----
$ TOKEN=glrt-t1_QnEnk-yx3sdgVT-DYt7i make pd-runner-podman
# This requires Podman >=4.1 <.>
#podman secret exists REGISTRATION_TOKEN && podman secret rm REGISTRATION_TOKEN || true
#podman secret exists config.toml && podman secret rm config.toml || true
Error: no secret with name or id "REGISTRATION_TOKEN": no such secret
Error: no secret with name or id "config.toml": no such secret
1a02dae2a667dbddbdc8bd7b0
Runtime platform                                    arch=amd64 os=linux pid=1 revision=690ce25c version=17.8.3
Running in system-mode.

Created missing unique system ID                    system_id=s_d3cc561989f6
Verifying runner... is valid                        runner=t1_QnEnk-
Runner registered successfully. Feel free to start it, but if it's running already the config should be automatically reloaded!

Configuration (with the authentication token) was saved in "/etc/gitlab-runner/config.toml"
# Fix SSL config to contact Gitlab registry
db86c90b8d202682014668223
pipglr-storage
pipglr-cache
8230fd623fc59d7621600304efcf1a11b5c9bf7cec5a8de5237b6d0143edb809 # <.>
----
<.> I really need to update this, meanwhile even my [Debian][] machine uses a decent version of Podman
<.> Yay!

The output looks promising, so let us verify our containers via Podman:

[source,shell]
----
$ podman ps -a --format 'table {{.ID}} {{.Image}} {{.Status}} {{.Names}}'
CONTAINER ID  IMAGE                                    STATUS                   NAMES
bfac4e6acb26  localhost/podman-pause:5.3.2-1737979078  Up 42 minutes            e91d11fdeb16-infra
cc6599fdf8db  docker.io/gitlab/gitlab-ce:latest        Up 42 minutes (healthy)  gitlab
8230fd623fc5  localhost/custom-pip-runner:latest       Up About a minute        pipglr
----

And also a quick glance at the runners list of Gitlab:

.Screenshot of our newly created runner
image::gitlab_runner.png[]




== Conclusion

All examples can be found here:

<https://github.com/unexist/showcase-dagger-golang>
